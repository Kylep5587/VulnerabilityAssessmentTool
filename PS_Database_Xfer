#Use this to pass in database connection info.
#$dataSource=$args[0]
#$dsn=$args[0]

#Database connection information
#Change when we figure out where the database will sit on the machine/website
$dataSource = "C:\VulnerabilityScannerData.accdb"
$dsn = "Provider=Microsoft.ACE.OLEDB.12.0; Data Source=$dataSource;Persist Security Info=False;"
$objConn = New-Object System.Data.OleDb.OleDbConnection $dsn
$objConn.Open()

#Scan Time to Send to Database
#$ScanTime = Get-Date -format g;

#This is the loop to check each application in the application list. Location of the CSV file ::: Might be changed for an array later.
$AppList = Import-Csv -Delimiter "," -Path "C:\Users\Public\Downloads\PC_info.csv"  
foreach ($App in $Applist){ 
    #Create the Varibles for each part of the database
	$DisplayName = $App.DisplayName
	$DisplayVersion = $App.DisplayVersion
	$InstallDate = $App.InstallDate
    #Change the data string into a Datetime
    $InstallDate = [datetime]::ParseExact($InstallDate, 'yyyyMMdd', $null)
    #Create the command to enter into the database.    
    $objCmd = $objConn.CreateCommand()
	$objCmd.CommandText = "INSERT INTO ApplicationList (ApplicationName,VersionNumber,InstallDate) VALUES (?,?,?)"
    #Create the parameteres for the Insert statement
    $objCmd.Parameters.AddwithValue("@ApplicationName",$DisplayName);
    $objCmd.Parameters.AddwithValue("@VersionNumber",$DisplayVersion);
    #Create an if loop to change the date to null if not install date is found.
    $objCmd.Parameters.Add("@InstallDate", [System.Data.OleDb.OleDbType]::DBdate, 225)
        if ($InstallDate -eq '')
        {
        $objCmd.Parameters["@InstallDate"].Value = [System.DBnull]::Value;
        }
	    else
        {
        $objCmd.Parameters["@InstallDate"].Value = $InstallDate;
        }
    #Remove # when if we add scan time to the database.
    #$objCmd.Parameters.AddwithValue("@ScanTime",$ScanTime);
    $objCmd.ExecuteNonQuery()

    }
#TODO: Put close in finally of try block
$objConn.Close()
