#Database connection information
$dataSource = "C:\Users\vansickj\Desktop\Jason\VulnerabilityScannerDataV2.accdb"
$dsn = "Provider=Microsoft.ACE.OLEDB.12.0; Data Source=$dataSource;Persist Security Info=False;"
$objConn = New-Object System.Data.OleDb.OleDbConnection $dsn
$objConn.Open()

#Variable for time the programs were scanned.
$ScanTime = Get-Date -format d;

#IP information
$portrange = 1..500
$timeout_ms = 5
$IP=[System.net.dns]::GetHostEntry($env:COMPUTERNAME).AddressList[0] | %{$_.IPAddressToString}
#Possible other way to find IP address
#$IP = Get-NetIPAddress -AddressFamily IPv4 | Where-Object { $_.ValidLifetime -ne ([TimeSpan]::MaxValue) } | Select -Property IPAddress


foreach ($IPAddress in $IP){
if (Test-Connection -BufferSize 32 -Count 1 -Quiet -ComputerName $IPaddress)
{
foreach ($port in $portrange)
       {
           $ErrorActionPreference = 'SilentlyContinue'
           $socket = new-object System.Net.Sockets.TcpClient
           $connect = $socket.BeginConnect($ipaddress, $port, $null, $null)
           $tryconnect = Measure-Command { $success = $connect.AsyncWaitHandle.WaitOne($timeout_ms, $true) } | % totalmilliseconds
           $tryconnect | Out-Null

                   if ($socket.Connected)
                   {
                        try {
                           $socket.Close()
                           $socket.Dispose()
                           $socket = $null

                           $command = $objConn.CreateCommand()
					       $command.CommandText = "SELECT Description FROM PortAssignments WHERE PortNumber = ?";
                           $command.Parameters.AddwithValue("@port",$port);
                           $Reader = $command.ExecuteReader();
                           while ($Reader.Read())
                            {
                              $portDescription = $Reader.GetValue(0) 
                            }
                           $objCmd = $objConn.CreateCommand()
                           $objCmd.CommandText = "INSERT INTO PortScanResults (PortNumber,Description,ScanDate) VALUES (?,?,?)"
                           #Create the parameteres for the Insert statement
                           $objCmd.Parameters.AddwithValue("@PortNumber",$port);
                           $objCmd.Parameters.AddwithValue("@Desciption",$portDescription);
                           $objCmd.Parameters.AddwithValue("@ScanDate",$ScanTime);
                           $objCmd.ExecuteNonQuery();
                        } catch {
                            $ErrorMessage = $_.Exception.Message
                            Write-Output "Error : " $ErrorMessage
                        }
                       
                   }
                   Else
                   {
                   }

                   $ErrorActionPreference = 'Continue'
           }
}
}
$objConn.Close();
